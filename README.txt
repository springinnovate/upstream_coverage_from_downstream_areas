Implementation from https://docs.google.com/document/d/11RtFtDOwC_Eu_4A0oOqW5lrJANlwZsShbNaY3xPrxDY/edit